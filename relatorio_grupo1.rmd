---
title: "Lung Adenocarcinoma Analysis (TCGA, GDC)"
author:
- Artur Gomes | PG55692
- Catarina Gomes | PG55694
- Maria Carvalho | PG55130
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---
<img src="EEUMLOGO.png" alt="Logo da Empresa" style="float:right; margin: 10px 10px 0 0; width: 110px; height: auto;" />

# {.tabset} 


## Dataset Download and Import

This analysis is conducted in R using Bioconductor packages and other essential libraries for statistical and machine learning applications. 

In this section, we will perform the following tasks: install and load the required packages, query and download gene expression data using the GDC data portal, and import the data into a suitable structure for downstream analysis.

### Installation and Import of Packages

This section presents all the packages used in this work, which support data acquisition and analysis throughout the document, enhancing the efficiency of retrieving and interpreting relevant information. The code checks whether each package is already installed and installs it if necessary.

```{r, results='hide', warning = FALSE, message=FALSE}

# Install BiocManager if not already installed
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

# List of Bioconductor packages
bioc_packages <- c(
  "TCGAbiolinks",
  "DESeq2",
  "Biobase",
  "genefilter",
  "pheatmap",
  "org.Hs.eg.db",
  "fgsea",
  "SummarizedExperiment",
  "Glimma",
  "edgeR",
  "AnnotationDbi"
)

# Install missing Bioconductor packages
for (pkg in bioc_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    BiocManager::install(pkg, ask = FALSE)
  }
}

# List of CRAN packages
cran_packages <- c(
  "jpeg",
  "ggbeeswarm",
  "ggplot2",
  "xfun",
  "factoextra",
  "Rtsne",
  "gplots",
  "RColorBrewer",
  "tidyverse",
  "rpart",
  "rsample",
  "caret"
)

# Install missing CRAN packages
for (pkg in cran_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

```

### Load Packages  

After installing the required packages, we need to load them into our R environment. The following command ensures all libraries are available for analysis:

```{r,results='hide', warning = FALSE, message=FALSE}
library(BiocManager)
library(jpeg)
library(TCGAbiolinks)
library(Biobase)
library(DESeq2)
library(ggbeeswarm)
library(genefilter)
library(pheatmap)
library(org.Hs.eg.db)
library(fgsea)
library(ggplot2)
library(xfun)
library(SummarizedExperiment) 
library(factoextra)
library(Rtsne)
library(gplots)
library(edgeR)
library(AnnotationDbi)
library(RColorBrewer)
library(tidyverse)
library(rpart)
library(rsample)
library(caret)
```

### Data Query and Preparation

The **`GDCquery()`** function is used to perform a query on the database. In this function, several parameters are defined to filter the dataset that will later be downloaded.

The **`project`** parameter corresponds to the ID assigned to the cancer type, allowing the selection of information specifically related to endometrial carcinoma of the uterine body. The **`data.category`** parameter is used to specify the data category to be selected. In this case, since the goal is to perform transcriptomic analysis, the category **"Transcriptome Profiling"** was selected to retrieve gene expression profiling data.

Among the available gene expression profiling data, the analysis was restricted to gene expression quantification by setting **`data.type`** to **"Gene Expression Quantification"**. Finally, the desired type of gene expression analysis was specified, opting for **"STAR-Counts"**. This workflow indicates that the algorithm used to count gene expression from aligned sequences was based on the **STAR** tool.

The **`GDCdownload()`** function is then used to download the data according to the query defined in the previous step. Next, the **`GDCprepare()`** function was used to generate a **`SummarizedExperiment`** object, compiling all the downloaded data into a single object to facilitate further analysis. It is worth noting that this function also allows saving the data in **.RData** format, making it easier to reload using the **`load()`** function.

> **Note**: This workflow enables the simultaneous download of both gene expression data and the associated metadata for the samples and genes.

```{r, message = FALSE}
# Define the base directory
base_dir <- "C:\\Users\\catar\\OneDrive\\Ambiente de Trabalho\\extracao\\projeto_r\\dadossss"  # Change this to your desired path

# Create directory if it doesn't exist
if (!dir.exists(base_dir)) {
  dir.create(base_dir, recursive = TRUE)
}

# File path for storing processed data
gdc_data <- file.path(base_dir, "GDCdata")
rna_seq_file <- file.path(base_dir, "mRNA_TCGA-LUAD.rda")

# Check if the data file already exists, if not, download and process
if (!file.exists(rna_seq_file)) {

  query_LUAD <- GDCquery(
    project = "TCGA-LUAD",
    data.category = "Transcriptome Profiling",
    data.type = "Gene Expression Quantification",
    workflow.type = "STAR - Counts"
  )

  GDCdownload(query = query_LUAD, directory = gdc_data)

  rna_seq_LUAD <- GDCprepare(
    query = query_LUAD,
    save = TRUE,
    save.filename = rna_seq_file,
    directory = gdc_data
  )

} else {
  rna_seq_LUAD <- get(load(rna_seq_file))
  rm(data)
}

```


## Contextualization of the Data

The **TCGA-LUAD (The Cancer Genome Atlas - Lung Adenocarcinoma) project** is part of the Genomic Data Commons (GDC), aimed at characterizing lung adenocarcinoma at the molecular level. It provides **clinical, genomic, and molecular** data, including patient demographics, tumor characteristics, sequencing data, and protein expression profiles.

### Dataset Composition

The TCGA-LUAD collection encompasses **600 lung adenocarcinoma samples** with extensive molecular profiling. The transcriptomic data captures expression levels for approximately **60,000 genes**, providing unprecedented breadth in molecular characterization. Following rigorous quality control and preprocessing procedures, **27,326 genes** were retained for downstream analysis, ensuring both data quality and comprehensive coverage of the transcriptome.

### Research Focus

This study focuses on analyzing **data and metadata** to assess quality, completeness, and usability. By examining metadata, we evaluate its role in ensuring data consistency, accessibility, and interoperability for research applications.

### Objectives

This project aims to:
- Identify differentially expressed genes (DEGs) in LUAD
- Investigate associations between gene expression and clinical variables
- Discover biomarkers or gene signatures for prognosis or treatment

### Research Applications

The richness and scale of this dataset make it an invaluable resource for:
1. **Expression Profiling**: Mapping transcriptional activity across the genome in lung adenocarcinoma
2. **Molecular Subtyping**: Classifying tumors into distinct biological and clinical entities
3. **Pathway Analysis**: Investigating dysregulated biological pathways driving LUAD development
4. **Integrative Analysis**: Combining transcriptomic data with other molecular layers and clinical information

### Significance in Lung Cancer Research

The comprehensive nature of the TCGA-LUAD dataset supports efforts in understanding the molecular mechanisms driving lung adenocarcinoma and developing personalized therapeutic strategies. By integrating clinical variables with genomic data, this resource enables a multidimensional approach to investigating one of the most common and lethal cancer subtypes.


## Data Pre Processing

In this stage, we preprocess the dataset to ensure its quality for differential expression and enrichment analysis. First, we separate the gene expression data from the metadata, structuring the dataset for efficient analysis. Then, we apply filtering techniques to remove noise, retaining only biologically relevant information that will enhance the accuracy of downstream analyses.


```{r}
# Extract gene expression matrix
expression_data <- as.data.frame(assay(rna_seq_LUAD))

# Extract clinical metadata
clinical_data <- colData(rna_seq_LUAD)

# Check the first few rows of each dataset
head(expression_data)[,1:5]  
head(clinical_data)

```

###Initial Data Exploration

```{r}
# Filter genes with low expression
keep_genes <- rowSums(expression_data > 1) > ncol(expression_data) * 0.5
expression_filtered <- expression_data[keep_genes, ]

cat("Dimensions:", dim(rna_seq_LUAD)[1], "genes x", dim(rna_seq_LUAD)[2], "samples\n")

# Summaries
summary(expression_filtered[1:5, 1:5])  
summary(clinical_data)

cat("Genes:", nrow(expression_filtered), "\n")
cat("Samples:", ncol(expression_filtered), "\n")

# Gene-wise statistics
gene_stats <- data.frame(
  Mean = rowMeans(expression_filtered),
  SD = apply(expression_filtered, 1, sd)
)
summary(gene_stats)
```

#### Gene and Sample Metadata

```{r}
gene_metadata <- rowData(rna_seq_LUAD)
sample_metadata <- colData(rna_seq_LUAD)
cat("Gene metadata:", dim(gene_metadata), "\n")
cat("Sample metadata:", dim(sample_metadata), "\n")
```

### Missing Values (NA)

We analyze missing values in the dataset to identify patterns, assess their impact, and determine the best approach for handling them, ensuring data integrity for further analysis.

```{r}
# For expression_data (gene expression matrix)
percent_missing_expression = colSums(is.na(expression_data)) / nrow(expression_data) * 100

# For clinical_data (clinical_data)
percent_missing_clinical = colSums(is.na(clinical_data)) / nrow(clinical_data) * 100

percent_missing_expression
percent_missing_clinical
```
There were no NAs for the `gene expression matrix`. In the `clinical_data` some values are missing (NA). We need to remove or impute these values to avoid bias.

```{r}
columns_with_na = names(clinical_data)[colSums(is.na(clinical_data)) > 0]

# Variables with NAs
print(columns_with_na)

```

A table was created listing the variables and their corresponding missing values (NAs) to help identify which variables were selected for this analysis.

```{r}
tabela_nas = data.frame(Variável = names(clinical_data), 
                         Total_NAs = colSums(is.na(clinical_data)))

print(tabela_nas)
```

As a general rule in data preprocessing, variables with a high proportion of missing values can introduce bias or reduce the power of statistical analyses. Therefore, we chose to exclude variables with more than 30% missing values. This threshold strikes a balance between preserving as much data as possible while ensuring that the retained variables are informative and complete enough for meaningful analysis.
By applying this filter, we focused the dataset on the most relevant and reliable features, which will improve the robustness of the downstream statistical and bioinformatic analyses.


```{r}
# Set the NA threshold
threshold = 30  # in percent

# For clinical data
clinical_data_filtered = clinical_data[, percent_missing_clinical <= threshold]

columns_with_no_na = names(clinical_data_filtered)[colSums(clinical_data_filtered)]
columns_with_no_na
```


To ensure the reliability of downstream analyses, genes with low expression across the majority of samples were filtered out. Specifically, only genes with counts greater than 1 in more than 50% of the samples were retained. This step helps reduce noise from lowly expressed or non-informative genes.

```{r}
# Keep only genes where at least 50% of samples have counts >1
keep = rowSums(expression_data > 1) > (0.5 * ncol(expression_data))
filtered_data = expression_data[keep, ]

```


1  PARTE - CATARINA

-LIMPAR DADOS
-FAZER MERGE

2.1 PARTE - CATARINA   
-FAZER CONTEXTUALIZACAO



2.2 PARTE - MARIA
-INTERPRETACAO DAS CENAS DA CATARINA (SUMMARIES)
-ESCOLHER AS 5 VARIAVEIS 
 -CONTEXTUALIZACAO DAS 5   (ESTATISTICAS DESCRITIVAS)
-APAGAR SAMPLES DE NAS


3  PARTE - ARTUR
-CLUSTERING

4 PARTE - CATARINA
-ANALISE DE EXPRESSAO DIFERENCIAL


