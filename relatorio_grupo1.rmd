---
title: "Lung Adenocarcinoma Analysis (TCGA, GDC)"
author:
- Artur Gomes | PG55692
- Catarina Gomes | PG55694
- Maria Carvalho | PG55130
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: default
---
<img src="EEUMLOGO.png" alt="Logo da Empresa" style="float:right; margin: 10px 10px 0 0; width: 110px; height: auto;" />

# {.tabset} 


## Dataset Download and Import

This analysis is conducted in R using Bioconductor packages and other essential libraries for statistical and machine learning applications. 

In this section, we will perform the following tasks: install and load the required packages, query and download gene expression data using the GDC data portal, and import the data into a suitable structure for downstream analysis.

### Installation and Import of Packages

This section presents all the packages used in this work, which support data acquisition and analysis throughout the document, enhancing the efficiency of retrieving and interpreting relevant information. The code checks whether each package is already installed and installs it if necessary.

```{r, results='hide', warning = FALSE, message=FALSE}

# Install BiocManager if not already installed
if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")

# List of Bioconductor packages
bioc_packages <- c(
  "TCGAbiolinks",
  "DESeq2",
  "Biobase",
  "genefilter",
  "pheatmap",
  "org.Hs.eg.db",
  "fgsea",
  "SummarizedExperiment",
  "Glimma",
  "edgeR",
  "AnnotationDbi"
)

# Install missing Bioconductor packages
for (pkg in bioc_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    BiocManager::install(pkg, ask = FALSE)
  }
}

# List of CRAN packages
cran_packages <- c(
  "jpeg",
  "ggbeeswarm",
  "ggplot2",
  "xfun",
  "factoextra",
  "Rtsne",
  "gplots",
  "RColorBrewer",
  "tidyverse",
  "rpart",
  "rsample",
  "caret"
)

# Install missing CRAN packages
for (pkg in cran_packages) {
  if (!requireNamespace(pkg, quietly = TRUE)) {
    install.packages(pkg)
  }
}

```

### Load Packages  

After installing the required packages, we need to load them into our R environment. The following command ensures all libraries are available for analysis:

```{r,results='hide', warning = FALSE, message=FALSE}
library(BiocManager)
library(jpeg)
library(TCGAbiolinks)
library(Biobase)
library(DESeq2)
library(ggbeeswarm)
library(genefilter)
library(pheatmap)
library(org.Hs.eg.db)
library(fgsea)
library(ggplot2)
library(xfun)
library(SummarizedExperiment) 
library(factoextra)
library(Rtsne)
library(gplots)
library(edgeR)
library(AnnotationDbi)
library(RColorBrewer)
library(tidyverse)
library(rpart)
library(rsample)
library(caret)
```

### Data Query and Preparation

The **`GDCquery()`** function is used to perform a query on the database. In this function, several parameters are defined to filter the dataset that will later be downloaded.

The **`project`** parameter corresponds to the ID assigned to the cancer type, allowing the selection of information specifically related to endometrial carcinoma of the uterine body. The **`data.category`** parameter is used to specify the data category to be selected. In this case, since the goal is to perform transcriptomic analysis, the category **"Transcriptome Profiling"** was selected to retrieve gene expression profiling data.

Among the available gene expression profiling data, the analysis was restricted to gene expression quantification by setting **`data.type`** to **"Gene Expression Quantification"**. Finally, the desired type of gene expression analysis was specified, opting for **"STAR-Counts"**. This workflow indicates that the algorithm used to count gene expression from aligned sequences was based on the **STAR** tool.

The **`GDCdownload()`** function is then used to download the data according to the query defined in the previous step. Next, the **`GDCprepare()`** function was used to generate a **`SummarizedExperiment`** object, compiling all the downloaded data into a single object to facilitate further analysis. It is worth noting that this function also allows saving the data in **.RData** format, making it easier to reload using the **`load()`** function.

> **Note**: This workflow enables the simultaneous download of both gene expression data and the associated metadata for the samples and genes.

```{r, message = FALSE}
# Define the base directory
base_dir <- "/Users/mariacarvalho/Desktop/Mestrado/2º\ semestre/Extração"  # Change this to your desired path

# Create directory if it doesn't exist
if (!dir.exists(base_dir)) {
  dir.create(base_dir, recursive = TRUE)
}

# File path for storing processed data
gdc_data <- file.path(base_dir, "GDCdata")
rna_seq_file <- file.path(base_dir, "mRNA_TCGA-LUAD.rda")

# Check if the data file already exists, if not, download and process
if (!file.exists(rna_seq_file)) {

  query_LUAD <- GDCquery(
    project = "TCGA-LUAD",
    data.category = "Transcriptome Profiling",
    data.type = "Gene Expression Quantification",
    workflow.type = "STAR - Counts"
  )

  GDCdownload(query = query_LUAD, directory = gdc_data)

  rna_seq_LUAD <- GDCprepare(
    query = query_LUAD,
    save = TRUE,
    save.filename = rna_seq_file,
    directory = gdc_data
  )

} else {
  rna_seq_LUAD <- get(load(rna_seq_file))
  rm(data)
}

```


## Contextualization of the Data

Lung adenocarcinoma is the most common form of lung cancer and is classified as a subtype of non-small cell lung cancer (NSCLC), representing about 40% of all lung cancer cases. It arises from the glandular cells of the lungs, which are responsible for producing mucus and lining the alveoli and other lung structures. This type of cancer typically develops in the outer, peripheral regions of the lungs and is known for its relatively slow growth compared to other lung cancer types [1][2].
Although there is a strong association with smoking, lung adenocarcinoma is also commonly found in non-smokers, particularly in younger women and individuals of Asian descent. It often emerges in areas of the lung affected by scarring or chronic inflammation. Early symptoms may be mild or vague, including fatigue, shortness of breath, or chest discomfort. As the disease advances, more pronounced signs can develop, such as a persistent cough, coughing up blood, and severe difficulty breathing [3][4].
The prognosis varies depending on the stage at diagnosis and response to treatment. Early detection improves survival rates significantly, while advanced cases may require multimodal therapies for disease management [2][4].

The **TCGA-LUAD (The Cancer Genome Atlas - Lung Adenocarcinoma) project** is part of the Genomic Data Commons (GDC), aimed at characterizing lung adenocarcinoma at the molecular level. It provides **clinical, genomic, and molecular** data, including patient demographics, tumor characteristics, sequencing data, and protein expression profiles.

### Dataset Composition

The TCGA-LUAD collection encompasses **600 lung adenocarcinoma samples** with extensive molecular profiling. The transcriptomic data captures expression levels for approximately **60,000 genes**, providing unprecedented breadth in molecular characterization. Following rigorous quality control and preprocessing procedures, **27,326 genes** were retained for downstream analysis, ensuring both data quality and comprehensive coverage of the transcriptome.

### Research Focus

This study focuses on analyzing **data and metadata** to assess quality, completeness, and usability. By examining metadata, we evaluate its role in ensuring data consistency, accessibility, and interoperability for research applications.

### Objectives

This project aims to:
- Identify differentially expressed genes (DEGs) in LUAD
- Investigate associations between gene expression and clinical variables
- Discover biomarkers or gene signatures for prognosis or treatment

### Research Applications

The richness and scale of this dataset make it an invaluable resource for:
1. **Expression Profiling**: Mapping transcriptional activity across the genome in lung adenocarcinoma
2. **Molecular Subtyping**: Classifying tumors into distinct biological and clinical entities
3. **Pathway Analysis**: Investigating dysregulated biological pathways driving LUAD development
4. **Integrative Analysis**: Combining transcriptomic data with other molecular layers and clinical information

### Significance in Lung Cancer Research

The comprehensive nature of the TCGA-LUAD dataset supports efforts in understanding the molecular mechanisms driving lung adenocarcinoma and developing personalized therapeutic strategies. By integrating clinical variables with genomic data, this resource enables a multidimensional approach to investigating one of the most common and lethal cancer subtypes.


## Data Pre Processing

In this stage, we preprocess the dataset to ensure its quality for differential expression and enrichment analysis. First, we separate the gene expression data from the metadata, structuring the dataset for efficient analysis. Then, we apply filtering techniques to remove noise, retaining only biologically relevant information that will enhance the accuracy of downstream analyses.


```{r}
# Extract gene expression matrix
expression_data <- as.data.frame(assay(rna_seq_LUAD))

# Extract clinical metadata
clinical_data <- colData(rna_seq_LUAD)

# Check the first few rows of each dataset
head(expression_data)[,1:5]  
head(clinical_data)

```

###Initial Data Exploration

```{r}
## SUMMARIZEDEXPERIMENT

metadata_rows = SummarizedExperiment::rowData(rna_seq_LUAD)
metadata_col = SummarizedExperiment::colData(rna_seq_LUAD)

metadata_rows   # DataFrame with 60660 rows and 10 columns
metadata_col    # DataFrame with 600 rows and 93 columns
```

Based on the exploration of the dataset, we can confirm that it is a SummarizedExperiment object composed of 60,660 rows and 600 columns. The rows correspond to individual genes, and each gene is annotated with 10 metadata fields. One of the key identifiers among these is the gene_id, which provides a unique Ensembl reference for each gene.
In contrast, the columns represent 600 biological samples, each described by 93 metadata variables. These metadata fields contain rich information about the samples — such as clinical, demographic, or experimental attributes — which are essential for investigating how various sample characteristics influence gene expression.
It’s also worth noting that the structure of the metadata changes when accessed directly: in the gene metadata (rowData), rows are indexed by gene identifiers; whereas in the sample metadata (colData), rows are indexed by sample IDs. This format makes it easier to analyze and query gene- or sample-specific information independently.

```{r}
# Filter genes with low expression
keep_genes <- rowSums(expression_data > 1) > ncol(expression_data) * 0.5
expression_filtered <- expression_data[keep_genes, ]

cat("Dimensions:", dim(rna_seq_LUAD)[1], "genes x", dim(rna_seq_LUAD)[2], "samples\n")
```

```{r}
# Summaries
summary(expression_filtered[1:5, 1:5])  # first 5 rows and first 5 columns
summary(clinical_data)

head(rownames(expression_filtered), 5)

cat("Genes:", nrow(expression_filtered), "\n") 
cat("Samples:", ncol(expression_filtered), "\n")
```
First five columns of the `expression_filtered`: TCGA-44-2665-01A; TCGA-97-7937-01A; TCGA-44-2665-11A; TCGA-44-2665-01B; TCGA-64-5774-01A

First five rows of the `expression_filtered`: ENSG00000000003.15; ENSG00000000419.13; ENSG00000000457.14; ENSG00000000460.17; ENSG00000000938.13

There are 27326 genes and 600 samples in the `expression_filtered` database.

```{r}
# Gene-wise statistics
gene_stats <- data.frame(
  Mean = rowMeans(expression_filtered),
  SD = apply(expression_filtered, 1, sd)
)
summary(gene_stats)
```
    There's a high variability in both the mean expression and standard deviation values across genes.
    The mean > median and high maximum values suggest a right-skewed distribution, likely driven by a few highly expressed genes.
    The wide range in SD also indicates heterogeneity in gene expression stability, which could help in selecting highly variable genes for downstream analysis (e.g., clustering or PCA).


#### Gene and Sample Metadata

```{r}
gene_metadata <- rowData(rna_seq_LUAD)
sample_metadata <- colData(rna_seq_LUAD)
cat("Gene metadata:", dim(gene_metadata), "\n")
cat("Sample metadata:", dim(sample_metadata), "\n")
```

### Missing Values (NA)

We analyze missing values in the dataset to identify patterns, assess their impact, and determine the best approach for handling them, ensuring data integrity for further analysis.

```{r}
# For expression_data (gene expression matrix)
percent_missing_expression = colSums(is.na(expression_data)) / nrow(expression_data) * 100

# For clinical_data (clinical_data)
percent_missing_clinical = colSums(is.na(clinical_data)) / nrow(clinical_data) * 100

percent_missing_expression
percent_missing_clinical
```
There were no NAs for the `gene expression matrix`. In the `clinical_data` some values are missing (NA). We need to remove or impute these values to avoid bias.

```{r}
columns_with_na = names(clinical_data)[colSums(is.na(clinical_data)) > 0]

# Variables with NAs
print(columns_with_na)

```

A table was created listing the variables and their corresponding missing values (NAs) to help identify which variables were selected for this analysis.

```{r}
tabela_nas = data.frame(Variável = names(clinical_data), 
                         Total_NAs = colSums(is.na(clinical_data)))

print(tabela_nas)
```

As a general rule in data preprocessing, variables with a high proportion of missing values can introduce bias or reduce the power of statistical analyses. Therefore, we chose to exclude variables with more than 30% missing values. This threshold strikes a balance between preserving as much data as possible while ensuring that the retained variables are informative and complete enough for meaningful analysis.
By applying this filter, we focused the dataset on the most relevant and reliable features, which will improve the robustness of the downstream statistical and bioinformatic analyses.


```{r}
# Set the NA threshold
threshold = 30  # in percent

# For clinical data
clinical_data_filtered = clinical_data[, percent_missing_clinical <= threshold]

columns_with_no_na <- names(clinical_data_filtered)[colSums(is.na(clinical_data_filtered)) == 0]

columns_with_no_na
```
After filtering the variables, we selected the following as our feature variables:
  `gender` : Biological sex of the patient (Male or Female --> Categorical Variable). Can influence disease prevalence and progression.
  
```{r}
## GENDER

barplot(table(clinical_data_filtered@listData[["gender"]]), 
        main = "Distribution of Gender", 
        xlab = "Gender", 
        ylab = "Count", 
        col = c("pink", "slategray1")[match(names(table(clinical_data_filtered@listData[["gender"]])), c("female", "male"))],
          border = "white")

```
  
  `race`: Self-reported racial background of the patient (Asian, American indian or Alaska native, Black or African American, White, Not Reported, Unknown --> Categorical Variable). May reflect epidemiological or socio-demographic patterns.
```{r}
## RACE

race_data <- clinical_data_filtered@listData[["race"]]
race_table <- table(race_data)

race_percent <- prop.table(race_table) * 100

race_df <- data.frame(
  Race = names(race_table),
  Count = as.vector(race_table),
  Percentage = round(as.vector(race_percent), 1)
)

print(race_df)
```
  Since the majority of patients are White (77.7%) or Black/African American (9.8%), and all other racial groups represent less than 2% each, we chose to focus our analysis on these two groups to ensure statistical relevance and interpretability.
  
```{r}
# Keep only rows where race is white or black or african american
clinical_data_filtered <- clinical_data_filtered[
  clinical_data_filtered@listData[["race"]] %in% c("white", "black or african american"),]
```

```{r}
barplot(table(clinical_data_filtered@listData[["race"]]),
        main = "Distribution of Race",
        xlab = "Race",
        ylab = "Count",
        col = c("lightseagreen", "salmon"),
          border = "white")
```
  `age_at_diagnosis`: Age of the patient at the time of initial diagnosis (In days --> Numerical Variable).
```{r}

age_in_years <- clinical_data_filtered@listData[["age_at_diagnosis"]] / 365.25

hist(age_in_years,
     main = "Age at Diagnosis Distribution",
     xlab = "Age",
     col = "snow3",
     breaks = 30,
       border = "white")  # adjust for bin size

```
  `primary_diagnosis`: Main clinical diagnosis assigned to the patient (Type of tumor --> Categorical Variable). Will help us understand if the type of the tumor will have influence in our response variable.

```{r}
diagnosis_data <- clinical_data_filtered@listData[["primary_diagnosis"]]
diagnosis_table <- table(diagnosis_data)
diagnosis_percent <- prop.table(diagnosis_table) * 100
diagnosis_percent
```
Since the majority of cases are concentrated in Adenocarcinoma, NOS (56.19%) and Adenocarcinoma with mixed subtypes (14.48%), and the other tumor types each represent less than 1%, with the 'Not Reported' category also being excluded, we will focus our analysis on these two tumor types to ensure statistical relevance and improve the interpretability of the results.
```{r}
# Filter out diagnoses with percentages < 1%
filtered_diagnosis <- diagnosis_percent[diagnosis_percent >= 1]

# Remove "Not Reported" from filtered diagnoses
final_diagnosis <- filtered_diagnosis[names(filtered_diagnosis) != "Not Reported"]

# View the final filtered data
final_diagnosis

```


```{r}
colors <- c("#6A0572", "#9D0191", "#FF6464", "#FFAB73", "#FFC93C", "#F9F871")

pie(
  final_diagnosis,
  main = "Primary Diagnosis",
  col = colors,
  border = "white"
)

```

  
  `tissue_type`: Indicates the type of sample (Tumor, Normal --> Categorical Variable). Useful for distinguishing between diseased and control samples.
  
```{r}
barplot(table(clinical_data_filtered@listData[["tissue_type"]]),
        main = "Distribution of Tissue Type",
        xlab = "Tissue Type",
        ylab = "Count",
        col = c("forestgreen", "darkred"),
          border = "white")
```
  
The response variable chosen is: `vital_status`. Indicates whether the patient is Alive or Dead at follow-up (Categorical Variable). It has a binary classification target. For us it will be useful for survival outcome prediction.

```{r}
barplot(table(clinical_data_filtered@listData[["vital_status"]]),
        main = "Distribution of Vital Status",
        xlab = "Vital Status",
        ylab = "Count",
        col = c("plum", "plum4"),
          border = "white")

```


To ensure the reliability of downstream analyses, genes with low expression across the majority of samples were filtered out. Specifically, only genes with counts greater than 1 in more than 50% of the samples were retained. This step helps reduce noise from lowly expressed or non-informative genes.




### Enrichment Analysis

After performing differential gene expression analysis, enrichment analysis was conducted to identify biological pathways significantly associated with the differentially expressed genes. The gene names were standardized to match those in the `.gmt` file, and the data were saved in a CSV format for ease of use. The "Hallmark" gene set was chosen as the background due to its representation of well-defined biological processes. Genes were sorted by decreasing log2 fold change, and duplicates were removed to ensure accurate results. The enrichment outcomes, ranked by adjusted p-value, were also saved to a CSV file.



### Bibliography

1. Myers DJ, Wallen JM. Lung Adenocarcinoma. 2023 Jun 12. In: StatPearls [Internet]. Treasure Island (FL): StatPearls Publishing; 2025 Jan–. PMID: 30137862.
2. Cancer Treatment Centers of America. (n.d.). Adenocarcinoma of the lung. Cancer Treatment Centers of America. https://www.cancercenter.com/cancer-types/lung-cancer/types/adenocarcinoma-of-the-lung
3. American Cancer Society. (n.d.). What is lung cancer? American Cancer Society. https://www.cancer.org/cancer/types/lung-cancer/about/what-is.html
4. Lung Cancer Foundation of America. (n.d.). Adenocarcinoma of the lung: An introduction. Lung Cancer Foundation of America. https://lcfamerica.org/about-lung-cancer/diagnosis/types/adenocarcinoma/






